<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gusto Reddit Sentiment Monitor - Dashboard</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem;
        }
        
        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .sentiment-positive { color: #28a745; }
        .sentiment-negative { color: #dc3545; }
        .sentiment-neutral { color: #6c757d; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .theme-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin: 0.2rem;
            display: inline-block;
        }
        
        .post-item {
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            border-radius: 0 10px 10px 0;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-reddit me-2"></i>
                Gusto Reddit Sentiment Monitor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#overview">Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#sentiment">Sentiment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#themes">Themes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#posts">Posts</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Date Filter Section -->
        <section id="date-filter" class="mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Data Filter</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="startDate" class="form-label">From:</label>
                                    <input type="date" id="startDate" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate" class="form-label">To:</label>
                                    <input type="date" id="endDate" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Overview Section -->
        <section id="overview" class="mb-5">
            <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>Overview</h2>
            
            <div class="row" id="overview-metrics">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading overview data...</p>
                </div>
            </div>
        </section>

        <!-- Reddit Data Collection Section -->
        <section id="reddit-management" class="mb-5">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fab fa-reddit me-2"></i>Reddit Data Sources</span>
                    <button class="btn btn-primary btn-sm" onclick="checkRedditData()">
                        <i class="fas fa-refresh me-2"></i>Check Data
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-users me-2"></i>Target Subreddits</h6>
                            <ul class="list-unstyled mb-3">
                                <li><i class="fas fa-circle text-success me-2" style="font-size: 0.5rem;"></i>r/smallbusiness</li>
                                <li><i class="fas fa-circle text-success me-2" style="font-size: 0.5rem;"></i>r/Entrepreneurship</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-search me-2"></i>Search Focus</h6>
                            <p class="text-muted mb-0">Monitoring Reddit discussions about payroll, HR software, and small business tools with focus on Gusto mentions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sentiment Analysis Section -->
        <section id="sentiment" class="mb-5">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-heart me-2"></i>Sentiment Distribution
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sentimentChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i>Sentiment Trends
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sentimentTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Themes Section -->
        <section id="themes" class="mb-5">
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-tags me-2"></i>Topic Sentiment Analysis (Reddit)
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="themesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-users me-2"></i>Competitor Mentions (Reddit)
                        </div>
                        <div class="card-body" id="competitors-list">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading competitors...
                            </div>
                        </div>
                    </div>
                </div>
                        </div>
        </section>



        <!-- Filtered Theme Posts Section -->
        <section id="theme-posts" class="mb-5" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-filter me-2"></i>
                        <span id="theme-posts-title">Filtered Posts</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideThemePosts()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <div class="card-body">
                    <div id="theme-posts-content">
                        <!-- Posts will be loaded here -->
                    </div>
                    <div id="theme-posts-pagination" class="mt-3">
                        <!-- Pagination will be added here -->
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Recent Posts Section -->
        <section id="posts" class="mb-5">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-comments me-2"></i>Recent Posts</span>
                    <div>
                        <select id="platformFilter" class="form-select form-select-sm d-inline-block" style="width: auto;">
                            <option value="">All Platforms</option>
                            <option value="reddit">Reddit</option>
                            <option value="youtube">YouTube</option>
                        </select>
                        <select id="sentimentFilter" class="form-select form-select-sm d-inline-block ms-2" style="width: auto;">
                            <option value="">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                </div>
                <div class="card-body" id="posts-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading recent posts...
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // Global chart configurations
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#6c757d';

        // API base URL
        const API_BASE = '/api';

        // Load posts by theme and sentiment
        async function loadThemePosts(theme, sentiment) {
            try {
                // Show loading
                document.getElementById('theme-posts').style.display = 'block';
                document.getElementById('theme-posts-title').textContent = `${sentiment.charAt(0).toUpperCase() + sentiment.slice(1)} Posts: ${theme}`;
                document.getElementById('theme-posts-content').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading posts...</div>';
                
                // Scroll to the section
                document.getElementById('theme-posts').scrollIntoView({ behavior: 'smooth' });
                
                const response = await axios.get(`${API_BASE}/posts-by-theme`, {
                    params: { theme, sentiment, per_page: 10 }
                });
                
                const data = response.data;
                displayThemePosts(data);
                
            } catch (error) {
                console.error('Error loading theme posts:', error);
                document.getElementById('theme-posts-content').innerHTML = '<div class="alert alert-danger">Error loading posts. Please try again.</div>';
            }
        }

        // Display filtered posts
        function displayThemePosts(data) {
            const container = document.getElementById('theme-posts-content');
            
            if (data.posts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No posts found for this theme and sentiment combination.</div>';
                return;
            }
            
            let html = '';
            data.posts.forEach(post => {
                const sentimentColor = post.sentiment_label === 'positive' ? 'success' : 
                                      post.sentiment_label === 'negative' ? 'danger' : 'secondary';
                const sentimentIcon = post.sentiment_label === 'positive' ? 'fa-smile' : 
                                     post.sentiment_label === 'negative' ? 'fa-frown' : 'fa-meh';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-1">
                                    <a href="${post.url}" target="_blank" class="text-decoration-none">
                                        ${post.title}
                                    </a>
                                </h6>
                                <span class="badge bg-${sentimentColor}">
                                    <i class="fas ${sentimentIcon} me-1"></i>
                                    ${post.sentiment_label}
                                </span>
                            </div>
                            <p class="card-text text-muted small mb-2">${post.content}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">
                                    <i class="fab fa-reddit me-1"></i>
                                    r/${post.subreddit} • u/${post.author}
                                    ${post.upvotes ? `• <i class="fas fa-arrow-up"></i> ${post.upvotes}` : ''}
                                </div>
                                <small class="text-muted">
                                    ${new Date(post.collected_at).toLocaleDateString()}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add pagination info
            const paginationContainer = document.getElementById('theme-posts-pagination');
            if (data.pagination.total > data.pagination.per_page) {
                paginationContainer.innerHTML = `
                    <div class="text-center text-muted">
                        Showing ${data.posts.length} of ${data.pagination.total} posts
                        ${data.pagination.pages > 1 ? `(Page ${data.pagination.page} of ${data.pagination.pages})` : ''}
                    </div>
                `;
            } else {
                paginationContainer.innerHTML = '';
            }
        }

        // Hide theme posts section
        function hideThemePosts() {
            document.getElementById('theme-posts').style.display = 'none';
        }

        // Load available competitors
        async function loadAvailableCompetitors() {
            try {
                const response = await axios.get(`${API_BASE}/available-competitors`);
                const data = response.data;
                
                const select = document.getElementById('competitorSelect');
                select.innerHTML = '<option value="">Select a competitor...</option>';
                
                data.competitors.forEach(competitor => {
                    const option = document.createElement('option');
                    option.value = competitor.name;
                    option.textContent = `${competitor.display_name} (${competitor.post_count} posts)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading competitors:', error);
                document.getElementById('competitorSelect').innerHTML = '<option value="">Error loading competitors</option>';
            }
        }

        // Load competitive analysis
        async function loadCompetitiveAnalysis() {
            const competitor = document.getElementById('competitorSelect').value;
            const theme = document.getElementById('themeSelect').value;
            
            if (!competitor || !theme) {
                // Clear chart if no selection
                const ctx = document.getElementById('competitiveChart').getContext('2d');
                if (window.competitiveChart) {
                    window.competitiveChart.destroy();
                }
                document.getElementById('competitiveSummary').style.display = 'none';
                return;
            }
            
            try {
                console.log('Making competitive analysis request:', { competitor, theme });
                const response = await axios.get(`${API_BASE}/competitor-analysis`, {
                    params: { competitor, theme }
                });
                const data = response.data;
                console.log('Competitive analysis response:', data);
                
                // Display the side-by-side sentiment comparison
                displayCompetitiveSentimentBars(data);
                
            } catch (error) {
                console.error('Error loading competitive analysis:', error);
                document.getElementById('competitiveSummary').innerHTML = '<div class="alert alert-danger">Error loading competitive analysis. Check browser console for details.</div>';
            }
        }

        // Display competitive analysis chart
        function displayCompetitiveChart(data) {
            console.log('Displaying competitive chart with data:', data);
            
            // First check if elements exist
            const chartCanvas = document.getElementById('competitiveChart');
            if (!chartCanvas) {
                console.error('Chart canvas not found!');
                return;
            }
            
            const ctx = chartCanvas.getContext('2d');
            
            // Destroy existing chart
            if (window.competitiveChart) {
                window.competitiveChart.destroy();
            }
            
            const gustoData = data.gusto_sentiment;
            const competitorData = data.competitor_sentiment;
            
            window.competitiveChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Gusto',
                        data: [gustoData.positive, gustoData.neutral, gustoData.negative],
                        backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(156, 163, 175, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                        borderColor: ['rgb(34, 197, 94)', 'rgb(156, 163, 175)', 'rgb(239, 68, 68)'],
                        borderWidth: 1
                    }, {
                        label: data.comparison.competitor,
                        data: [competitorData.positive, competitorData.neutral, competitorData.negative],
                        backgroundColor: ['rgba(34, 197, 94, 0.5)', 'rgba(156, 163, 175, 0.5)', 'rgba(239, 68, 68, 0.5)'],
                        borderColor: ['rgb(34, 197, 94)', 'rgb(156, 163, 175)', 'rgb(239, 68, 68)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Sentiment Comparison: Gusto vs ${data.comparison.competitor} - ${data.comparison.theme}`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `${context[0].label} Sentiment`;
                                },
                                afterBody: function(context) {
                                    return [`Total posts analyzed: ${data.comparison.total_posts}`];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Display competitive analysis summary
        function displayCompetitiveSummary(data) {
            const gustoData = data.gusto_sentiment;
            const competitorData = data.competitor_sentiment;
            
            // Calculate percentages
            const gustoTotal = gustoData.total || 1;
            const competitorTotal = competitorData.total || 1;
            
            const gustoPositivePercent = Math.round((gustoData.positive / gustoTotal) * 100);
            const gustoNegativePercent = Math.round((gustoData.negative / gustoTotal) * 100);
            
            const competitorPositivePercent = Math.round((competitorData.positive / competitorTotal) * 100);
            const competitorNegativePercent = Math.round((competitorData.negative / competitorTotal) * 100);
            
            // Gusto summary
            document.getElementById('gustoSummary').innerHTML = `
                <div class="mb-2">
                    <span class="badge bg-success">${gustoData.positive} Positive (${gustoPositivePercent}%)</span>
                    <span class="badge bg-secondary ms-1">${gustoData.neutral} Neutral</span>
                    <span class="badge bg-danger ms-1">${gustoData.negative} Negative (${gustoNegativePercent}%)</span>
                </div>
                <small class="text-muted">Total mentions: ${gustoData.total}</small>
            `;
            
            // Competitor summary
            document.getElementById('competitorSummaryTitle').textContent = `${data.comparison.competitor} Performance`;
            document.getElementById('competitorSummaryContent').innerHTML = `
                <div class="mb-2">
                    <span class="badge bg-success">${competitorData.positive} Positive (${competitorPositivePercent}%)</span>
                    <span class="badge bg-secondary ms-1">${competitorData.neutral} Neutral</span>
                    <span class="badge bg-danger ms-1">${competitorData.negative} Negative (${competitorNegativePercent}%)</span>
                </div>
                <small class="text-muted">Total mentions: ${competitorData.total}</small>
            `;
            
            document.getElementById('competitiveSummary').style.display = 'block';
            
            // Show and populate competitive posts
            displayCompetitivePosts(data.analyzed_posts);
        }
        
        // Display competitive posts
        function displayCompetitivePosts(posts) {
            const container = document.getElementById('competitivePostsContent');
            
            if (!posts || posts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No posts found for this comparison.</div>';
                document.getElementById('competitivePosts').style.display = 'block';
                return;
            }
            
            let html = '';
            posts.forEach(post => {
                const isGusto = post.type === 'gusto';
                const sentimentClass = post.sentiment === 'positive' ? 'sentiment-positive' : 
                                     post.sentiment === 'negative' ? 'sentiment-negative' : 'sentiment-neutral';
                const typeClass = isGusto ? 'border-primary' : 'border-warning';
                const typeLabel = isGusto ? 'Gusto' : 'Competitor';
                const typeBadgeClass = isGusto ? 'bg-primary' : 'bg-warning';
                
                html += `
                    <div class="post-item ${typeClass} mb-3" data-sentiment="${post.sentiment}" data-type="${post.type}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">${post.title || 'No title'}</h6>
                            <div>
                                <span class="badge ${typeBadgeClass} me-2">${typeLabel}</span>
                                <small class="text-muted">Reddit</small>
                            </div>
                        </div>
                        <p class="mb-2">${post.content}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="${sentimentClass} fw-bold">${post.sentiment}</span>
                                <small class="text-muted ms-2">${post.sentiment_score}</small>
                            </div>
                            <small class="text-muted">
                                ${new Date(post.collected_at).toLocaleDateString()}
                                ${post.url ? `• <a href="${post.url}" target="_blank">View</a>` : ''}
                            </small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('competitivePosts').style.display = 'block';
        }
        
        // Filter competitive posts by sentiment
        function filterCompetitivePosts(sentiment) {
            const posts = document.querySelectorAll('#competitivePostsContent .post-item');
            
            posts.forEach(post => {
                if (sentiment === 'all' || post.getAttribute('data-sentiment') === sentiment) {
                    post.style.display = 'block';
                } else {
                    post.style.display = 'none';
                }
            });
            
            // Update button states
            document.querySelectorAll('#competitivePosts button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Display competitive sentiment bars side-by-side
        function displayCompetitiveSentimentBars(data) {
            console.log('Displaying competitive sentiment bars with data:', data);
            
            const gustoSentiment = data.gusto_sentiment;
            const competitorSentiment = data.competitor_sentiment;
            const comparison = data.comparison;
            
            // Calculate percentages
            const gustoTotal = gustoSentiment.total || 1;
            const competitorTotal = competitorSentiment.total || 1;
            
            const gustoPositivePercent = Math.round((gustoSentiment.positive / gustoTotal) * 100);
            const gustoNeutralPercent = Math.round((gustoSentiment.neutral / gustoTotal) * 100);
            const gustoNegativePercent = Math.round((gustoSentiment.negative / gustoTotal) * 100);
            
            const competitorPositivePercent = Math.round((competitorSentiment.positive / competitorTotal) * 100);
            const competitorNeutralPercent = Math.round((competitorSentiment.neutral / competitorTotal) * 100);
            const competitorNegativePercent = Math.round((competitorSentiment.negative / competitorTotal) * 100);
            
            // Create the side-by-side sentiment comparison HTML
            const competitiveSummaryHtml = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-center mb-3">
                            <span class="badge bg-primary">Gusto</span> vs 
                            <span class="badge bg-warning">${comparison.competitor}</span>
                            - ${comparison.theme}
                        </h5>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Gusto Column -->
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white text-center">
                                <h6 class="mb-0">Gusto Sentiment</h6>
                                <small>${gustoSentiment.total} posts analyzed</small>
                            </div>
                            <div class="card-body">
                                <!-- Positive Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-success fw-bold">Positive</span>
                                        <span class="badge bg-success">${gustoSentiment.positive} (${gustoPositivePercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${gustoPositivePercent}%" 
                                             aria-valuenow="${gustoPositivePercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Neutral Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-secondary fw-bold">Neutral</span>
                                        <span class="badge bg-secondary">${gustoSentiment.neutral} (${gustoNeutralPercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" 
                                             style="width: ${gustoNeutralPercent}%" 
                                             aria-valuenow="${gustoNeutralPercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Negative Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-danger fw-bold">Negative</span>
                                        <span class="badge bg-danger">${gustoSentiment.negative} (${gustoNegativePercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-danger" role="progressbar" 
                                             style="width: ${gustoNegativePercent}%" 
                                             aria-valuenow="${gustoNegativePercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competitor Column -->
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark text-center">
                                <h6 class="mb-0">${comparison.competitor} Sentiment</h6>
                                <small>${competitorSentiment.total} posts analyzed</small>
                            </div>
                            <div class="card-body">
                                <!-- Positive Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-success fw-bold">Positive</span>
                                        <span class="badge bg-success">${competitorSentiment.positive} (${competitorPositivePercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${competitorPositivePercent}%" 
                                             aria-valuenow="${competitorPositivePercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Neutral Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-secondary fw-bold">Neutral</span>
                                        <span class="badge bg-secondary">${competitorSentiment.neutral} (${competitorNeutralPercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" 
                                             style="width: ${competitorNeutralPercent}%" 
                                             aria-valuenow="${competitorNeutralPercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Negative Bar -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-danger fw-bold">Negative</span>
                                        <span class="badge bg-danger">${competitorSentiment.negative} (${competitorNegativePercent}%)</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-danger" role="progressbar" 
                                             style="width: ${competitorNegativePercent}%" 
                                             aria-valuenow="${competitorNegativePercent}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Insights -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-light">
                            <h6>Quick Insights:</h6>
                            <ul class="mb-0">
                                <li><strong>Positive sentiment:</strong> 
                                    ${gustoPositivePercent > competitorPositivePercent ? 
                                        `Gusto leads with ${gustoPositivePercent}% vs ${competitorPositivePercent}%` : 
                                        competitorPositivePercent > gustoPositivePercent ?
                                        `${comparison.competitor} leads with ${competitorPositivePercent}% vs ${gustoPositivePercent}%` :
                                        `Tied at ${gustoPositivePercent}%`}
                                </li>
                                <li><strong>Negative sentiment:</strong> 
                                    ${gustoNegativePercent < competitorNegativePercent ? 
                                        `Gusto performs better (${gustoNegativePercent}% vs ${competitorNegativePercent}%)` : 
                                        competitorNegativePercent < gustoNegativePercent ?
                                        `${comparison.competitor} performs better (${competitorNegativePercent}% vs ${gustoNegativePercent}%)` :
                                        `Tied at ${gustoNegativePercent}%`}
                                </li>
                                <li><strong>Data volume:</strong> 
                                    ${gustoTotal > competitorTotal ? 
                                        `More Gusto discussions (${gustoTotal} vs ${competitorTotal} posts)` : 
                                        competitorTotal > gustoTotal ?
                                        `More ${comparison.competitor} discussions (${competitorTotal} vs ${gustoTotal} posts)` :
                                        `Equal discussion volume (${gustoTotal} posts each)`}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the competitive summary section
            document.getElementById('competitiveSummary').style.display = 'block';
            document.getElementById('competitiveSummary').innerHTML = competitiveSummaryHtml;
            
            // Also show the posts if available
            if (data.analyzed_posts && data.analyzed_posts.length > 0) {
                displayCompetitivePosts(data.analyzed_posts);
            }
        }

        // Initialize date filter with default values
        function initializeDateFilter() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30); // Default to last 30 days
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Add event listeners
            document.getElementById('startDate').addEventListener('change', refreshDashboard);
            document.getElementById('endDate').addEventListener('change', refreshDashboard);
        }
        
        // Refresh entire dashboard based on date filter
        async function refreshDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                console.log(`Refreshing dashboard for date range: ${startDate} to ${endDate}`);
                
                // Show loading indicators
                document.getElementById('overview-metrics').innerHTML = '<div class="loading text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Refreshing data...</p></div>';
                document.getElementById('posts-container').innerHTML = '<div class="loading text-center"><i class="fas fa-spinner fa-spin"></i> Refreshing posts...</div>';
                
                // Refresh all sections
                try {
                    await Promise.all([
                        loadOverview(),
                        loadSentimentData(),
                        loadThemesData(),
                        loadRecentPosts()
                    ]);
                    console.log('Dashboard refresh completed');
                } catch (error) {
                    console.error('Error refreshing dashboard:', error);
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            initializeDateFilter();
            
            // Load data with error handling
            Promise.all([
                loadOverview(),
                loadSentimentData(),
                loadThemesData(),
                loadCompetitors(),
                loadRecentPosts()
            ]).then(() => {
                console.log('Dashboard loaded successfully');
            }).catch(error => {
                console.error('Dashboard loading error:', error);
            });
            
            // Setup filters
            document.getElementById('platformFilter').addEventListener('change', loadRecentPosts);
            document.getElementById('sentimentFilter').addEventListener('change', loadRecentPosts);
        });

        // Load overview metrics
        async function loadOverview() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `${API_BASE}/overview`;
                if (startDate && endDate) {
                    url += `?start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await axios.get(url);
                const data = response.data;
                
                const metricsHtml = `
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card">
                            <div class="metric-number">${data.total_posts}</div>
                            <div class="metric-label">Total Posts</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card">
                            <div class="metric-number">${data.avg_sentiment_score.toFixed(2)}</div>
                            <div class="metric-label">Avg Sentiment</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card">
                            <div class="metric-number">${data.recent_posts_7_days}</div>
                            <div class="metric-label">Recent (7 days)</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card">
                            <div class="metric-number">${((data.sentiment_breakdown.positive / data.total_posts) * 100).toFixed(0)}%</div>
                            <div class="metric-label">Positive Rate</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('overview-metrics').innerHTML = metricsHtml;
            } catch (error) {
                console.error('Error loading overview:', error);
                document.getElementById('overview-metrics').innerHTML = '<div class="alert alert-danger">Error loading overview data</div>';
            }
        }

        // Load sentiment data and create charts
        async function loadSentimentData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let overviewUrl = `${API_BASE}/overview`;
                let trendsUrl = `${API_BASE}/sentiment-trends`;
                
                if (startDate && endDate) {
                    overviewUrl += `?start_date=${startDate}&end_date=${endDate}`;
                    trendsUrl += `?start_date=${startDate}&end_date=${endDate}`;
                }
                
                const [overviewResponse, trendsResponse] = await Promise.all([
                    axios.get(overviewUrl),
                    axios.get(trendsUrl)
                ]);
                
                const overviewData = overviewResponse.data;
                const trendsData = trendsResponse.data;
                
                // Sentiment pie chart
                try {
                    const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.sentimentChart && typeof window.sentimentChart.destroy === 'function') {
                        window.sentimentChart.destroy();
                    }
                    
                    const sentimentData = [
                        overviewData.sentiment_breakdown.positive || 0,
                        overviewData.sentiment_breakdown.negative || 0,
                        overviewData.sentiment_breakdown.neutral || 0
                    ];
                    const sentimentTotal = sentimentData.reduce((a, b) => a + b, 0);
                    
                    console.log('Sentiment data:', sentimentData, 'Total:', sentimentTotal);
                    
                    if (sentimentTotal > 0) {
                        window.sentimentChart = new Chart(sentimentCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Positive', 'Negative', 'Neutral'],
                                datasets: [{
                                    data: sentimentData,
                                    backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.parsed;
                                                const percentage = ((value / sentimentTotal) * 100).toFixed(1);
                                                return `${context.label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                },
                                onClick: function(event, elements) {
                                    if (elements.length > 0) {
                                        const element = elements[0];
                                        const index = element.index;
                                        const sentiments = ['positive', 'negative', 'neutral'];
                                        const sentiment = sentiments[index];
                                        
                                        // Filter posts by the clicked sentiment
                                        document.getElementById('sentimentFilter').value = sentiment;
                                        loadRecentPosts();
                                        
                                        // Scroll to the posts section
                                        document.getElementById('posts-section').scrollIntoView({ behavior: 'smooth' });
                                    }
                                }
                            }
                        });
                    } else {
                        console.warn('No sentiment data available');
                    }
                } catch (error) {
                    console.error('Error creating sentiment chart:', error);
                }
                
                // Sentiment trend line chart
                try {
                    const trendCtx = document.getElementById('sentimentTrendChart').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.sentimentTrendChart && typeof window.sentimentTrendChart.destroy === 'function') {
                        window.sentimentTrendChart.destroy();
                    }
                    
                    if (trendsData.trends && trendsData.trends.length > 0) {
                        window.sentimentTrendChart = new Chart(trendCtx, {
                            type: 'line',
                            data: {
                                labels: trendsData.trends.map(t => new Date(t.date).toLocaleDateString()),
                                datasets: [{
                                    label: 'Average Sentiment',
                                    data: trendsData.trends.map(t => t.avg_sentiment),
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: -1,
                                        max: 1
                                    }
                                }
                            }
                        });
                    } else {
                        console.warn('No trends data available');
                    }
                } catch (error) {
                    console.error('Error creating trends chart:', error);
                }
                
            } catch (error) {
                console.error('Error loading sentiment data:', error);
            }
        }

        // Load themes data
        async function loadThemesData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `${API_BASE}/themes`;
                if (startDate && endDate) {
                    url += `?start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await axios.get(url);
                const data = response.data;
                
                // Store data globally for onClick access
                window.themesData = data;
                
                try {
                    const ctx = document.getElementById('themesChart').getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.themesChart && typeof window.themesChart.destroy === 'function') {
                        window.themesChart.destroy();
                    }
                    
                    if (data.top_themes && data.top_themes.length > 0) {
                        window.themesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.top_themes.map(t => t.name),
                        datasets: [{
                            label: 'Positive',
                            data: data.top_themes.map(t => t.positive_count),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }, {
                            label: 'Neutral',
                            data: data.top_themes.map(t => t.neutral_count),
                            backgroundColor: 'rgba(156, 163, 175, 0.8)',
                            borderColor: 'rgb(156, 163, 175)',
                            borderWidth: 1
                        }, {
                            label: 'Negative',
                            data: data.top_themes.map(t => t.negative_count),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    afterBody: function(context) {
                                        const themeIndex = context[0].dataIndex;
                                        const theme = window.themesData.top_themes[themeIndex];
                                        return [
                                            '',
                                            `Total mentions: ${theme.total_mentions}`,
                                            '',
                                            theme.description,
                                            '',
                                            'Click to view posts with this sentiment'
                                        ];
                                    }
                                }
                            }
                        },
                        onClick: function(event, elements) {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const datasetIndex = element.datasetIndex;
                                const index = element.index;
                                
                                const theme = window.themesData.top_themes[index];
                                const sentiments = ['positive', 'neutral', 'negative'];
                                const sentiment = sentiments[datasetIndex];
                                
                                // Load posts for this theme and sentiment
                                loadThemePosts(theme.name, sentiment);
                            }
                        }
                    }
                        });
                    } else {
                        console.warn('No themes data available');
                    }
                } catch (chartError) {
                    console.error('Error creating themes chart:', chartError);
                }
            } catch (error) {
                console.error('Error loading themes data:', error);
            }
        }

        // Load competitors
        async function loadCompetitors() {
            try {
                const response = await axios.get(`${API_BASE}/competitors`);
                const competitors = response.data.competitors;
                
                let html = '';
                if (competitors.length === 0) {
                    html = '<p class="text-muted">No competitor mentions found</p>';
                } else {
                    competitors.forEach(comp => {
                        const sentimentClass = comp.avg_sentiment > 0 ? 'sentiment-positive' : 
                                            comp.avg_sentiment < 0 ? 'sentiment-negative' : 'sentiment-neutral';
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${comp.name}</span>
                                <span>
                                    <span class="badge bg-secondary">${comp.mention_count}</span>
                                    <span class="${sentimentClass} ms-2">${comp.avg_sentiment.toFixed(2)}</span>
                                </span>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('competitors-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading competitors:', error);
                document.getElementById('competitors-list').innerHTML = '<div class="alert alert-danger">Error loading competitors</div>';
            }
        }

        // Load recent posts
        async function loadRecentPosts() {
            try {
                const platform = document.getElementById('platformFilter').value;
                const sentiment = document.getElementById('sentimentFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `${API_BASE}/posts?per_page=10`;
                if (platform) url += `&platform=${platform}`;
                if (sentiment) url += `&sentiment=${sentiment}`;
                if (startDate && endDate) {
                    url += `&start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await axios.get(url);
                const posts = response.data.posts;
                
                let html = '';
                if (posts.length === 0) {
                    html = '<p class="text-muted">No posts found</p>';
                } else {
                    posts.forEach(post => {
                        const sentimentClass = post.sentiment_label === 'positive' ? 'sentiment-positive' : 
                                            post.sentiment_label === 'negative' ? 'sentiment-negative' : 'sentiment-neutral';
                        
                        const themesHtml = post.themes.map(theme => `<span class="theme-badge">${theme}</span>`).join('');
                        
                        html += `
                            <div class="post-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">${post.title || 'No title'}</h6>
                                    <small class="text-muted">${post.platform}</small>
                                </div>
                                <p class="mb-2">${post.content}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        ${themesHtml}
                                    </div>
                                    <div>
                                        <span class="${sentimentClass} fw-bold">${post.sentiment_label}</span>
                                        <small class="text-muted ms-2">${post.sentiment_score.toFixed(2)}</small>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    ${post.author} • ${new Date(post.created_at).toLocaleDateString()}
                                    ${post.url ? `• <a href="${post.url}" target="_blank">View</a>` : ''}
                                </small>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('posts-container').innerHTML = html;
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('posts-container').innerHTML = '<div class="alert alert-danger">Error loading posts</div>';
            }
        }

        // Data Management Functions
        async function checkRedditData() {
            try {
                const response = await axios.get(`${API_BASE}/posts?platform=reddit&per_page=1`);
                const totalRedditPosts = response.data.pagination ? response.data.pagination.total : 0;
                
                alert(`Total Reddit posts in database: ${totalRedditPosts}`);
                return totalRedditPosts;
            } catch (error) {
                console.error('Error checking Reddit data:', error);
                alert('Error checking Reddit data');
                return 0;
            }
        }

        // YouTube functionality has been removed - focusing on Reddit only


    </script>
</body>
</html> 